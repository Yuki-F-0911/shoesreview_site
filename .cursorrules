---
description: Apply this rule to the entire repository
globs: 
alwaysApply: true
---

あなたは高度な問題解決能力を持つAIアシスタントです。以下の指示に従って、効率的かつ正確にタスクを遂行してください。

## プロジェクト概要

このプロジェクトは**Next.js 14.2.0**を使用したシューズレビューサイトです。
- **フレームワーク**: Next.js 14.2.0 (App Router)
- **言語**: TypeScript 5.3.3
- **データベース**: PostgreSQL 18.1.1 + Prisma 5.11.0
- **認証**: NextAuth.js 5.0.0-beta
- **スタイリング**: Tailwind CSS 3.4.0

---

## 1. タスク分析と計画

### 実装前の確認事項

**必須チェック項目**:
- 既存の類似機能・コンポーネントの有無を確認
- 同名または類似名の関数・コンポーネントの重複チェック
- 重複するAPIエンドポイントの確認
- 共通化可能な処理の特定
- `technologystack.md`で定義されたバージョンとの整合性確認
- `directorystructure.md`で定義されたディレクトリ構造の遵守

### 技術スタックの制約

**重要**: `technologystack.md`に記載されたバージョンは**明示的な承認なしに変更しないでください**。
- Next.js: 14.2.0
- React: 18.3.0
- TypeScript: 5.3.3
- Prisma: 5.11.0
- その他のバージョンも同様に厳守

バージョン変更が必要な場合は：
1. 変更理由を明確にする
2. 影響範囲を調査する
3. 承認を得る
4. `technologystack.md`を更新する

---

## 2. 実装時のルール

### ディレクトリ構造

`directorystructure.md`で定義された構造に従ってください：

- **ページ**: `src/app/(main)/` または `src/app/(auth)/`
- **API Routes**: `src/app/api/{resource}/route.ts`
- **コンポーネント**: 
  - UI基本コンポーネント: `src/components/ui/`
  - 機能特化コンポーネント: `src/components/{feature}/`
  - レイアウト: `src/components/layout/`
- **ロジック**: 
  - データアクセス: `src/lib/prisma/queries/`
  - バリデーション: `src/lib/validations/`
  - ユーティリティ: `src/lib/utils/`
- **型定義**: `src/types/`

### パスエイリアス

必ず`@/`エイリアスを使用してください：
```typescript
import { Button } from '@/components/ui/Button'
import { prisma } from '@/lib/prisma/client'
import { useAuth } from '@/hooks/useAuth'
```

### 命名規則

- **コンポーネント**: PascalCase（例: `ReviewCard.tsx`）
- **ユーティリティ**: camelCase（例: `formatDate.ts`）
- **フォルダ**: kebab-case（例: `custom-hooks/`）
- **カスタムフック**: `use`接頭辞（例: `useAuth.ts`）

### Next.js App Routerの規約

- Server Componentsをデフォルトで使用
- Client Componentsが必要な場合のみ`'use client'`を追加
- Server Actionsは`src/app/api/`ではなく、Server Components内で直接定義可能
- 動的ルートは`[id]`形式を使用

### Prismaの使用

- Prisma Clientは`src/lib/prisma/client.ts`からインポート
- データベースクエリは`src/lib/prisma/queries/`に配置
- マイグレーションは`npm run db:migrate`で実行

### バリデーション

- Zodスキーマは`src/lib/validations/`に配置
- React Hook FormとZodを組み合わせて使用
- サーバーサイドとクライアントサイドで同じスキーマを使用

### コードスタイル

- TypeScriptのstrictモードを有効化
- ESLintとPrettierの設定に従う
- インポート順序：
  1. React / Next.js
  2. 外部ライブラリ
  3. 内部モジュール（`@/`エイリアス）
  4. 型定義
  5. スタイル

---

## 3. 禁止事項

### 絶対に禁止

1. **セットアップ用のmdファイル（SETUP.md等）を作成しない**
   - セットアップ手順が必要な場合は、既存のREADME.mdに追記するか、ユーザーに確認を取る

2. **技術スタックのバージョンを勝手に変更しない**
   - `technologystack.md`に記載されたバージョンは厳守

3. **UI/UXデザインの変更（レイアウト、色、フォント、間隔など）**
   - 変更が必要な場合は、事前に理由を示し、承認を得る

4. **明示的に指示されていない変更を行わない**
   - 必要と思われる変更がある場合は、提案として報告し、承認を得る

5. **重複実装**
   - 実装前に既存コードを確認し、再利用可能なコードを探す

---

## 4. 品質管理

### 実装後の検証

- 型エラーの確認（TypeScript）
- リンターエラーの確認（ESLint）
- 実装した機能の動作確認
- 既存機能への影響確認

### エラー対応

問題が発生した場合：
1. エラーメッセージとログを確認
2. 原因を特定
3. 対策を実施
4. 動作検証

---

## 5. コミュニケーション

### 確認が必要な場合

以下の場合は必ず確認を取ってください：
- 技術スタックのバージョン変更
- UI/UXデザインの変更
- ディレクトリ構造の変更
- 既存機能への大きな影響がある変更
- 不明点や重要な判断が必要な場合

### 報告形式

重要な変更や問題が発生した場合は、以下の形式で報告：
- 問題の概要
- 原因の分析
- 提案する解決策
- 影響範囲

---

## 6. コード例

### Server Componentの例

```typescript
import { prisma } from '@/lib/prisma/client'
import { ReviewCard } from '@/components/reviews/ReviewCard'

export default async function ReviewsPage() {
  const reviews = await prisma.review.findMany({
    include: { user: true, shoe: true },
  })
  
  return (
    <div>
      {reviews.map((review) => (
        <ReviewCard key={review.id} review={review} />
      ))}
    </div>
  )
}
```

### Client Componentの例

```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/Button'

export function ReviewForm() {
  const [isSubmitting, setIsSubmitting] = useState(false)
  // ...
}
```

### API Routeの例

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma/client'
import { reviewSchema } from '@/lib/validations/review'

export async function GET(request: NextRequest) {
  const reviews = await prisma.review.findMany()
  return NextResponse.json(reviews)
}

export async function POST(request: NextRequest) {
  const body = await request.json()
  const validated = reviewSchema.parse(body)
  // ...
}
```

---

## 7. 最終確認

実装完了後：
- すべてのタスクが完了しているか確認
- 当初の指示内容との整合性を確認
- 重複実装がないことを確認
- コードスタイルと規約に準拠しているか確認

---

以上のルールに従い、確実で質の高い実装を行います。指示された範囲内でのみ処理を行い、不要な追加実装は行いません。

